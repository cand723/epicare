<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analisis Gejala TBC - Lanjutan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./style/style.css" />
  <style>
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .glass {
      background-color: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    }
    #popup {
      background: #ffffff;
      color: #1a1a1a;
    }
    #popup button {
      background: #10b981;
    }
    #popup button:hover {
      background: #059669;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-100 via-blue-50 to-purple-50 text-gray-800 min-h-screen flex flex-col">

  <div id="navbar-placeholder" class="flex-shrink-0 h-16"></div>
  <script>
fetch('navbar.html')
  .then(response => response.text())
  .then(data => {
    document.getElementById('navbar-placeholder').innerHTML = data;
    // Reattach menu toggle event listener after loading navbar
    document.getElementById('menu-toggle').addEventListener('click', function () {
      const mobileMenu = document.getElementById('mobile-menu');
      mobileMenu.classList.toggle('hidden');
    });
  });

  </script>

  <main class="px-4 md:px-8 max-w-7xl mx-auto mt-24 mb-10">
    <section class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-blue-600 drop-shadow-lg mb-4">Analisis Gejala TBC (Lanjutan)</h1>
      <p class="text-lg md:text-xl mt-1 text-gray-600 max-w-2xl mx-auto">Sistem lanjutan untuk deteksi TBC berdasarkan gejala tambahan</p>
    </section>

    <form class="grid md:grid-cols-2 gap-6 text-center">
      <div>
        <div class="glass p-6 rounded-2xl shadow-lg space-y-6">
          <div>
            <label class="block font-semibold mb-2 text-lg text-gray-800">Q11. Apakah Anda mudah tersinggung akhir-akhir ini?</label>
            <div class="flex gap-6 justify-center">
              <label><input type="radio" name="q11" value="0" class="mr-1 accent-green-600" /> Tidak/Ringan</label>
              <label><input type="radio" name="q11" value="1" class="mr-1 accent-green-600" /> Sedang</label>
              <label><input type="radio" name="q11" value="2" class="mr-1 accent-green-600" /> Parah</label>
            </div>
            <hr class="border-gray-300 mt-3" />
          </div>

          <div>
            <label class="block font-semibold mb-2 text-lg text-gray-800">Q12. Apakah Anda kehilangan nafsu makan?</label>
            <div class="flex gap-6 justify-center">
              <label><input type="radio" name="q12" value="0" class="mr-1 accent-green-600" /> Tidak/Ringan</label>
              <label><input type="radio" name="q12" value="1" class="mr-1 accent-green-600" /> Sedang</label>
              <label><input type="radio" name="q12" value="2" class="mr-1 accent-green-600" /> Parah</label>
            </div>
            <hr class="border-gray-300 mt-3" />
          </div>

          <div>
            <label class="block font-semibold mb-2 text-lg text-gray-800">Q13. Apakah Anda merasa kekurangan energi?</label>
            <div class="flex gap-6 justify-center">
              <label><input type="radio" name="q13" value="0" class="mr-1 accent-green-600" /> Tidak/Ringan</label>
              <label><input type="radio" name="q13" value="1" class="mr-1 accent-green-600" /> Sedang</label>
              <label><input type="radio" name="q13" value="2" class="mr-1 accent-green-600" /> Parah</label>
            </div>
            <hr class="border-gray-300 mt-3" />
          </div>

          <div>
            <label class="block font-semibold mb-2 text-lg text-gray-800">Q14. Apakah Anda mengalami pembesaran kelenjar getah bening?</label>
            <div class="flex gap-6 justify-center">
              <label><input type="radio" name="q14" value="0" class="mr-1 accent-green-600" /> Tidak/Ringan</label>
              <label><input type="radio" name="q14" value="1" class="mr-1 accent-green-600" /> Sedang</label>
              <label><input type="radio" name="q14" value="2" class="mr-1 accent-green-600" /> Parah</label>
            </div>
            <hr class="border-gray-300 mt-3" />
          </div>
        </div>

        <div class="flex justify-center mt-6">
          <a href="./sistem_analisis.html" class="bg-green-600 hover:bg-green-700 transition text-white px-8 py-3 rounded-xl shadow-lg text-lg font-semibold">‚¨Ö Prev</a>
        </div>
      </div>

      <div>
        <div class="glass p-6 rounded-2xl shadow-lg space-y-6">
          <div>
            <label class="block font-semibold mb-2 text-lg text-gray-800">Q15. Apakah tekanan darah sistolik Anda tinggi?</label>
            <div class="flex gap-6 justify-center">
              <label><input type="radio" name="q15" value="0" class="mr-1 accent-green-600" /> Tidak/Ringan</label>
              <label><input type="radio" name="q15" value="1" class="mr-1 accent-green-600" /> Sedang</label>
              <label><input type="radio" name="q15" value="2" class="mr-1 accent-green-600" /> Parah</label>
            </div>
            <hr class="border-gray-300 mt-3" />
          </div>

        <div class="glass p-6 rounded-2xl shadow-lg space-y-6 mt-6">
          <div>
            <label for="berat" class="block font-semibold mb-2 text-lg text-gray-800">Berat Badan Anda (kg)</label>
            <input type="number" id="berat" name="berat" required min="30" max="200" class="w-full p-3 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label for="tinggi" class="block font-semibold mb-2 text-lg text-gray-800">Tinggi Badan Anda (cm)</label>
            <input type="number" id="tinggi" name="tinggi" required min="100" max="250" class="w-full p-3 border border-gray-300 rounded-lg" />
          </div>
        </div>


        <div class="flex justify-center mt-6">
          <button type="button" id="predict-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl shadow-lg text-lg font-semibold">Prediksi</button>
        </div>

        <div id="prediction-result" class="hidden mt-4 px-6 py-4 bg-green-100 border border-green-300 rounded-xl text-center text-gray-800 font-medium"></div>

        <div id="loading-spinner" class="mt-6 hidden flex items-center justify-center h-24">
          <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-green-600"></div>
        </div>
      </div>
    </form>

    <div class="flex justify-center mt-10">
      <button type="button" onclick="resetAndBack()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl shadow-md font-medium">üîÅ Reset & Kembali ke Awal</button>
    </div>
  </main>

  <div id="popup-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div id="popup" class="p-6 rounded-xl shadow-lg max-w-sm text-center border border-gray-200">
      Mohon isi semua pertanyaan sebelum melanjutkan.
      <br />
      <button id="popup-close-btn" class="mt-4 px-4 py-2 rounded-full text-white font-semibold">Tutup</button>
    </div>
  </div>
<script>
  function resetAndBack() {
    localStorage.clear();
    window.location.href = './sistem_analisis.html';
  }

  const formDataPage1 = JSON.parse(localStorage.getItem('formData')) || {};

  document.addEventListener('DOMContentLoaded', () => {
    const savedData = JSON.parse(localStorage.getItem('formDataPage2')) || {};

    ['q11', 'q12', 'q13', 'q14', 'q15'].forEach(key => {
      const value = savedData[key];
      if (value !== null) {
        const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
        if (radio) radio.checked = true;
      }
    });

    if (savedData.berat) document.getElementById('berat').value = savedData.berat;
    if (savedData.tinggi) document.getElementById('tinggi').value = savedData.tinggi;
  });

  function saveFormDataPage2() {
    const formData = {};
    ['q11', 'q12', 'q13', 'q14', 'q15'].forEach(q => {
      formData[q] = document.querySelector(`input[name="${q}"]:checked`)?.value || null;
    });
    formData.berat = document.getElementById('berat')?.value || '';
    formData.tinggi = document.getElementById('tinggi')?.value || '';

    localStorage.setItem('formDataPage2', JSON.stringify(formData));
  }

  document.querySelectorAll('input[type="radio"]').forEach(input => {
    input.addEventListener('change', saveFormDataPage2);
  });
  document.getElementById('berat').addEventListener('input', saveFormDataPage2);
  document.getElementById('tinggi').addEventListener('input', saveFormDataPage2);

  function collectFormDataPage2() {
    const formData = {};
    ['q11', 'q12', 'q13', 'q14', 'q15'].forEach(q => {
      formData[q] = document.querySelector(`input[name="${q}"]:checked`)?.value || null;
    });
    return formData;
  }

  async function sendDataToAPI() {
    const formData = collectFormDataPage2();
    const allAnswered = Object.values(formData).every(value => value !== null);
    if (!allAnswered) {
      document.getElementById('popup-overlay').classList.remove('hidden');
      return;
    }

    const beratStr = document.getElementById("berat")?.value;
    const tinggiStr = document.getElementById("tinggi")?.value;
    const berat = parseFloat(beratStr);
    const tinggi = parseFloat(tinggiStr);

    if (!beratStr || !tinggiStr || isNaN(berat) || isNaN(tinggi) || berat <= 0 || tinggi <= 0) {
      alert("‚ö†Ô∏è Harap isi berat dan tinggi badan Anda dengan benar.");
      return;
    }

    const finalData = { ...formDataPage1, ...formData };
    const dataToSend = [
      finalData.q1, finalData.q2, finalData.q3, finalData.q4,
      finalData.q5, finalData.q6, finalData.q7, finalData.q8,
      finalData.q9, finalData.q10, finalData.q11, finalData.q12,
      finalData.q13, finalData.q14, finalData.q15,
      berat, tinggi
    ];

    const numericData = dataToSend.map(value => parseFloat(value));
    const spinner = document.getElementById('loading-spinner');
    const predictionElement = document.getElementById('prediction-result');
    spinner.classList.remove('hidden');
    predictionElement.innerHTML = ""; // Kosongkan hasil prediksi saat loading

    try {
      const response = await fetch('https://epicare-fullstack.onrender.com/predict/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(numericData)
      });

      const result = await response.json();
      displayPredictionResult(result);
    } catch (error) {
      console.error("Error sending data to API:", error);
      predictionElement.innerHTML = `<p class="text-red-500">‚ùå Terjadi kesalahan. Silakan coba lagi.</p>`;
    } finally {
      spinner.classList.add('hidden');
    }
  }

  function displayPredictionResult(result) {
    const predictionElement = document.getElementById('prediction-result');
    predictionElement.classList.remove('hidden');
    let percentage = parseFloat(result.prediction);
    let message = '';
    if (percentage < 30) {
      message = 'Risiko terdeteksi rendah. Tetap jaga pola hidup sehat dan kebersihan.';
    } else if (percentage < 60) {
      message = 'Risiko sedang terdeteksi. Sebaiknya lakukan pemeriksaan medis lebih lanjut.';
    } else {
      message = 'Risiko tinggi terdeteksi. Segera lakukan konsultasi dengan dokter atau fasilitas kesehatan terdekat.';
    }
    predictionElement.innerHTML = `
      <p class="text-sm mb-2">üîç <strong>Hasil Anda :</strong></p>
      <p class="text-4xl font-bold mb-2">${percentage}%</p>
      <p class="text-base">${message}</p>
    `;
  }

  document.getElementById('predict-btn').addEventListener('click', sendDataToAPI);
  document.getElementById('popup-close-btn').addEventListener('click', () => {
    document.getElementById('popup-overlay').classList.add('hidden');
  });
</script>
</body>
</html>
